using Std::Test::Assertions::*
using Std::Test::*

describe "Weak", ->
	context "init", ->
		should "create from a box", ->
			a := Box(3)
			w := Weak(a)
			assert! w <<: Weak

			b := w.to_box
			assert! b <<: Box
			assert! b.must.get == 3
		end

		should "create from an immutable box", ->
			a := ImmutableBox(3)
			w := Weak(a)
			assert! w <<: Weak

			b := w.to_box
			assert! b <<: Box
			assert! b.must.get == 3
		end

		should "create from a local box", ->
			a := 3
			b := &a
			w := Weak(b)
			assert! w <<: Weak

			c := w.to_box
			assert! c <<: Box
			assert! c.must.get == 3
		end
	end

	context "to_immutable_box", ->
		should "return a box when the object is alive", ->
			a := Box(3)
			w := Weak(a)
			assert! w <<: Weak

			b := w.to_immutable_box
			assert! b <<: ImmutableBox
			assert! b.must.get == 3
		end

		should "return nil when the object is gced", ->
			a := Box(3)
			w := Weak(a)

			a = Box(0)
			Runtime.gc

			assert! w.to_immutable_box == nil
		end
	end

	context "to_box", ->
		should "return a box when the object is alive", ->
			a := Box(3)
			w := Weak(a)
			assert! w <<: Weak

			b := w.to_box
			assert! b <<: Box
			assert! b.must.get == 3
		end

		should "return nil when the object is gced", ->
			a := Box(3)
			w := Weak(a)

			a = Box(0)
			Runtime.gc

			assert! w.to_box == nil
		end
	end

end
